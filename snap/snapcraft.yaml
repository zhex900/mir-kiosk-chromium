name: chromium-mir-kiosk
version: 65.0.3325.146
summary: Chromium web browser in Kiosk mode on Mir
description: |
 An open-source browser project that aims to build a safer, faster, and more
 stable way for all Internet users to experience the web.
confinement: strict
grade: devel

apps:
  chromium:
    command: desktop-launch chromium-browser.launcher
    daemon: simple
    desktop: usr/share/applications/chromium.desktop
    environment:
      DISABLE_WAYLAND: 1
      CHROME_DESKTOP: chromium.desktop
    slots: [ x11 ]
    plugs:
      - browser-sandbox
      - camera
      - cups-control
      - desktop
      - gsettings
      - hardware-observe
      - home
      - mir # due to mir-kiosk using /dev/shm in wayland implementation
      - mount-observe
      - network
      - network-bind
      - opengl
      - password-manager-service
      - pulseaudio
      - screen-inhibit-control
      - wayland
      - x11-plug

plugs:
  browser-sandbox:
    interface: browser-support
    allow-sandbox: true

  x11-plug: # because cannot have identical plug/slot name in same yaml.
    interface: x11

parts:
  ppa-build:
    plugin: nil
    build-packages:
      - software-properties-common
    stage-packages:
      - libgl1-mesa-glx
      - libgnome-keyring0
      - libnss3
      - pulseaudio
    prepare: |
      apt install software-properties-common
      V=65.0.3325.146-0ubuntu0.16.04.1
      add-apt-repository -y ppa:chromium-team/stable
      apt update
      apt install -y chromium-browser=$V chromium-browser-l10n=$V chromium-codecs-ffmpeg-extra=$V
    install: |
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/lib
      cp -R /usr/lib/chromium-browser $SNAPCRAFT_PART_INSTALL/usr/lib/
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/bin
      cp /usr/bin/chromium-browser $SNAPCRAFT_PART_INSTALL/usr/bin/
      mkdir -p $SNAPCRAFT_PART_INSTALL/etc
      cp -R /etc/chromium-browser $SNAPCRAFT_PART_INSTALL/etc/
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/scalable/apps
      cp /usr/share/icons/hicolor/scalable/apps/chromium-browser.svg \
          $SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/scalable/apps/chromium.svg
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/share/applications
      cp /usr/share/applications/chromium-browser.desktop \
          $SNAPCRAFT_PART_INSTALL/usr/share/applications/chromium.desktop
      sed -i \
          -e "s:^Exec=chromium-browser\(.*\):Exec=chromium\1:g" \
          -e "s:^Icon=chromium-browser$:Icon=/usr/share/icons/hicolor/scalable/apps/chromium.svg:" \
          $SNAPCRAFT_PART_INSTALL/usr/share/applications/chromium.desktop
      chmod 4555 $SNAPCRAFT_PART_INSTALL/usr/lib/chromium-browser/chrome-sandbox

  kiosk-extension:
    plugin: nil
    source: git://github.com/cook-company/kiosk.git
    build: |
      bash ../../../snap/makekioskcrx.sh kiosk $PWD
    build-packages: [ openssl, vim-common, zip ] # vim-common for xxd
    install: |
      cp extension.id $SNAPCRAFT_PART_INSTALL
      extension=`cat extension.id`
      mkdir -p $SNAPCRAFT_PART_INSTALL/var/www
      cp "${extension}.crx" $SNAPCRAFT_PART_INSTALL/var/www
      mkdir -p $SNAPCRAFT_PART_INSTALL/etc/chromium-browser/policies/managed/
      sed "s|%%EXTENSION%%|\"$extension;http://localhost:8088/updates.xml\"|g" \
          < ../../../snap/chromium-policy.json.in \
          > $SNAPCRAFT_PART_INSTALL/etc/chromium-browser/policies/managed/chromium-policy.json
      sed "s|%%EXTENSION%%|$extension|g" \
          < ../../../snap/updates.xml.in \
          > $SNAPCRAFT_PART_INSTALL/var/www/updates.xml


  launcher:
    plugin: dump
    source: snap
    after: [desktop-gtk3-fixed-cache]
    organize:
      chromium-browser.launcher: bin/
      crx-server.py: bin/
      i3.config: etc/

  xwayland:
    plugin: nil
    stage-packages:
      - xwayland
      - i3

  xwayland-preload:
    plugin: cmake
    source: xwayland-preload
    build-packages:
      - build-essential
